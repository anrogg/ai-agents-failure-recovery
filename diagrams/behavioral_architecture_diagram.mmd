# Behavioral Failure Detection System Architecture

This document contains the **implemented** architecture diagram for the behavioral anomaly detection system, based on the current codebase.

## System Architecture Overview (Current Implementation)

```mermaid
graph TB
    %% User Request Flow
    User[ğŸ‘¤ User Request] --> Agent[ğŸ¤– AI Agent Service]

    %% Main Processing Pipeline
    Agent --> Generate[Generate Response]
    Generate --> Response[ğŸ“ AI Response]

    %% NEW: Service Layer Pattern
    Response --> BehavioralService[ğŸ¯ Behavioral Monitoring Service<br/>âœ… IMPLEMENTED<br/>Service Layer Pattern]

    %% Service Layer Components
    BehavioralService --> MetricsCollector[ğŸ“ˆ Prometheus Metrics<br/>âœ… FULLY INTEGRATED<br/>â€¢ Interaction counters<br/>â€¢ Anomaly histograms<br/>â€¢ Behavioral drift tracking]

    BehavioralService --> DatabasePersistence[ğŸ—ƒï¸ Database Persistence<br/>âœ… FULLY INTEGRATED<br/>â€¢ InteractionBehaviorLog<br/>â€¢ BehavioralAnomalyLog<br/>â€¢ BehavioralBaseline]

    %% Pure Business Logic (No Infrastructure)
    BehavioralService --> InteractionTracker[ğŸ“Š Interaction Tracker<br/>âœ… PURE LOGIC<br/>Track behavioral metrics]
    BehavioralService --> AnomalyDetector[ğŸš¨ Anomaly Detector<br/>âœ… PURE LOGIC<br/>Detect anomalies]

    %% Interaction Tracking (FULLY IMPLEMENTED)
    InteractionTracker --> TrackMetrics[Track Complete Metrics<br/>â€¢ Response Latency<br/>â€¢ Message Length<br/>â€¢ Conversation Turns<br/>â€¢ Clarification Frequency<br/>â€¢ Topic Switches<br/>â€¢ Confidence Expressions]
    TrackMetrics --> SessionStore[(ğŸ—„ï¸ In-Memory Session Store<br/>âœ… IMPLEMENTED<br/>Last 10 responses + persistence)]

    %% Anomaly Detection Pipeline (FULLY IMPLEMENTED)
    AnomalyDetector --> BaselineManager[ğŸ“ˆ Baseline Manager<br/>âœ… PURE LOGIC<br/>Statistical analysis]
    AnomalyDetector --> LoopDetector[ğŸ”„ Loop Detector<br/>âœ… PURE LOGIC<br/>3-tier detection]
    AnomalyDetector --> TemporalAnalyzer[â±ï¸ Temporal Analyzer<br/>âœ… PURE LOGIC<br/>Basic drift detection]

    %% Detection Methods (WHAT'S WORKING)
    BaselineManager --> EstablishBaseline[Statistical Baselines<br/>âœ… Z-score deviation<br/>âœ… Percentile ranges<br/>âœ… Adaptive thresholds]

    LoopDetector --> LoopDetection[Loop Detection<br/>âœ… Exact repetition 100%<br/>âœ… Alternating patterns 95%<br/>âœ… Low diversity configurable]

    TemporalAnalyzer --> DriftDetection[Drift Detection<br/>âœ… Framework implemented<br/>ğŸš§ Basic algorithms only]

    %% Database Integration (FULLY IMPLEMENTED)
    DatabasePersistence --> Database[(ğŸ—ƒï¸ PostgreSQL<br/>âœ… FULLY INTEGRATED<br/>Uses existing models<br/>â€¢ async_session<br/>â€¢ Auto-commit)]

    %% Results Processing (IMPLEMENTED)
    EstablishBaseline --> Results[ğŸ“Š Anomaly Results<br/>âœ… IMPLEMENTED]
    LoopDetection --> Results
    DriftDetection --> Results

    Results --> ComprehensiveResult[âœ…/âŒ Complete Analysis<br/>âœ… IMPLEMENTED<br/>â€¢ Anomaly detection<br/>â€¢ Metrics recording<br/>â€¢ Database persistence<br/>â€¢ Confidence scores<br/>â€¢ Recommendations]

    %% Monitoring (FULLY IMPLEMENTED)
    MetricsCollector --> PrometheusMetrics[ğŸ“ˆ Prometheus Integration<br/>âœ… FULLY IMPLEMENTED<br/>â€¢ interaction_total<br/>â€¢ behavioral_anomaly_score<br/>â€¢ conversation_flow_disruptions<br/>â€¢ interaction_consistency_score]

    DatabasePersistence --> StructuredLogging[ğŸ“ Structured Logging<br/>âœ… IMPLEMENTED<br/>â€¢ Anomaly warnings<br/>â€¢ Processing info<br/>â€¢ Error handling]

    %% Validation Pipeline Integration
    ComprehensiveResult --> Validator{ğŸ” Output Validator}
    Validator --> Format[ğŸ“‹ Format Validation]
    Format --> Content[ğŸ“„ Content Validation]
    Content --> BehavioralValidation[ğŸ¯ Behavioral Validation<br/>âœ… INTEGRATED]
    BehavioralValidation -->|Optional| Semantic[ğŸ§  Semantic Validation]

    %% Response Flow
    Semantic --> FinalResponse[ğŸ“¤ Final Response to User]

    %% Configuration (IMPLEMENTED)
    Config[âš™ï¸ Environment Config<br/>âœ… IMPLEMENTED<br/>â€¢ BEHAVIORAL_TRACKING_ENABLED<br/>â€¢ BEHAVIORAL_METRICS_ENABLED<br/>â€¢ BEHAVIORAL_DB_PERSISTENCE_ENABLED] -.-> BehavioralService

    %% NOT IMPLEMENTED (Grayed Out)
    subgraph NotImplemented[" âŒ NOT IMPLEMENTED "]
        AdvancedTemporal[Advanced Temporal Analysis]
        SemanticLoops[Semantic Loop Detection]
        PopulationBaselines[Population-Based Analysis]
        PredictiveModels[Predictive ML Models]
        AutoRecovery[Auto-Recovery Systems]
        AlertingSystem[External Alerting System]
    end

    %% Styling
    classDef implemented fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef partial fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef notimplemented fill:#ffebee,stroke:#c62828,stroke-width:1px,stroke-dasharray: 5 5
    classDef primary fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef service fill:#f3e5f5,stroke:#4a148c,stroke-width:3px

    class Agent,Validator,BehavioralValidation primary
    class BehavioralService service
    class MetricsCollector,DatabasePersistence,InteractionTracker,AnomalyDetector,BaselineManager,LoopDetector,TemporalAnalyzer implemented
    class TrackMetrics,SessionStore,EstablishBaseline,LoopDetection,DriftDetection,Results,ComprehensiveResult,Database,PrometheusMetrics,StructuredLogging,Config implemented
    class Format,Content,Semantic,FinalResponse implemented
    class AdvancedTemporal,SemanticLoops,PopulationBaselines,PredictiveModels,AutoRecovery,AlertingSystem notimplemented
```

## Simple Data Flow (Current Reality)

```mermaid
flowchart LR
    %% Input Data
    Request[User Request] --> Processing{Agent Processing}

    %% Real-time Metrics Collection (IMPLEMENTED)
    Processing --> BasicMetrics[Basic Metrics Collection<br/>âœ… Response time<br/>âœ… Message length<br/>âœ… Turn count]

    %% Storage Layer (IMPLEMENTED)
    BasicMetrics --> Memory[(Session Storage<br/>âœ… Last 10 responses<br/>âœ… Database persistence)]

    %% Analysis Layer (IMPLEMENTED)
    Memory --> SimpleAnalysis{Behavioral Analysis}

    %% Detection Algorithms (FULLY IMPLEMENTED)
    SimpleAnalysis --> LoopCheck[Loop Detection<br/>âœ… 3-tier system<br/>âœ… 95%+ accuracy]
    SimpleAnalysis --> StatCheck[Statistical Analysis<br/>âœ… Z-score deviation<br/>âœ… Baseline tracking]
    SimpleAnalysis --> PatternCheck[Pattern Analysis<br/>âœ… Anomaly detection<br/>âœ… Drift analysis]

    %% Results (IMPLEMENTED)
    LoopCheck --> ComprehensiveResult[Complete Analysis<br/>âœ… Anomaly scores<br/>âœ… Recommendations<br/>âœ… Confidence levels]
    StatCheck --> ComprehensiveResult
    PatternCheck --> ComprehensiveResult

    %% Output (FULLY IMPLEMENTED)
    ComprehensiveResult --> StructuredLogging[Structured Logging<br/>âœ… Anomaly warnings<br/>âœ… Processing info]
    ComprehensiveResult --> PrometheusMetrics[Prometheus Metrics<br/>âœ… 12+ metrics<br/>âœ… Real-time collection]
    ComprehensiveResult --> DatabasePersistence[Database Storage<br/>âœ… Async writes<br/>âœ… 3 tables]

    %% Styling
    classDef working fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef partial fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef input fill:#e3f2fd,stroke:#1976d2,stroke-width:2px

    class Request,Processing input
    class BasicMetrics,LoopCheck,StatCheck,PatternCheck,ComprehensiveResult,StructuredLogging,PrometheusMetrics,DatabasePersistence working
    class Memory,SimpleAnalysis working
```

## Configuration (What Actually Works)

```mermaid
mindmap
  root)Configuration Status(
    Environment Variables
      BEHAVIORAL_TRACKING_ENABLED: true/false
      BEHAVIORAL_METRICS_ENABLED: true/false
      BEHAVIORAL_DB_PERSISTENCE_ENABLED: true/false
      OUTPUT_VALIDATION_LEVEL: behavioral
    Detection Settings
      Loop detection: 3-tier thresholds
      Baseline: 3-5 min interactions
      Memory: Last 10 responses
      Anomaly threshold: configurable
    YAML Configuration
      config/failure_scenarios.yml
      Behavioral anomaly settings
      Recovery strategies
      Monitoring thresholds
```